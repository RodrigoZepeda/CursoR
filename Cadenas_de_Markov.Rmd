---
title: "Modelaje Epidemiológico en `R`"
subtitle: "Cadenas de Markov"
author: "Rodrigo Zepeda"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: 
    tufte_features: ["fonts", "background","italics"]
    toc: false
    includes:
      in_header: javascriptcall.html
    css: style.css
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
bibliography: skeleton.bib
link-citations: yes
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE, message = FALSE, warnign = FALSE}
library("ggplot2")
library("gridExtra")
library("cowplot")

filedir <- "~/Dropbox/CURSO_INSP_2019/course_files/"
options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tufte'), error = TRUE)
options(htmltools.dir.version = FALSE)
```
## Cadenas de Markov
Una cadena de Markov es un proceso aleatorio

UNA EXPLICACIÓN PRECIOSA Y DIVERTIDA
FIGURA DE UN MODELO SIR Y DISMOD

Las cadenas de Markov se componen de: 

1. Estados 
2. Probabilidades de pasar de un estado a otro. 

Todo el chiste de la cadena de Markov en R es obtener esas probabilidades, lo demás R lo hace solito.
Para esto utilizaremos el paquete `markovchain`

```{r, message= FALSE}
#No olvides instalarlo primero
library(markovchain)
```
Volviendo al modelo SIR, supongamos que las probabilidades de pasar de un estado a otro son las siguientes:

1. P(Seguir susceptible) = 0.73 
2. P(Susceptible a infectado) = 0.27 
3. P(Infectados a susceptible) = 0.11 
4. P(Seguir infectado) = 0.89

Con estos datos podemos construír una `matríz de transición`. Una matríz es un arreglo de datos (del mismo tipo) que se compone de filas y columnas. Nosotros queremos que nuestra matríz de transición se vea así:
$$
\begin{array}{cccc} 
& Susceptibles & Infectados\\
Susceptibles   & 0.73 & 0.27 \\
Infectados     & 0.11 & 0.89
\end{array}
$$

Para construír la matríz en R usamos el comando matrix(), que básicamente funciona asi:

$$
\text{matrix}(\underbrace{datos}_{vector},\overbrace{nrow}^{filas \ deseadas}, \underbrace{ncol}_{columnas \ deseadas},\overbrace{byrow}^{como \ quiero\ rellenar})
$$
Entonces para construír nuestra matríz de transición necesitamos el vector de probabilidades, 2 filas y 2 columnas

```{r}
#Vector de probabilidades
probs <- c(0.73, 0.27, 0.11, 0.89)

#Matríz de 2x2
matriz <- matrix(probs, nrow = 2, ncol= 2, byrow= TRUE) 
```

Para crear una cadena de Markov en R usando esas probabilidades hacemos:
```{r}
cadena1 <- new("markovchain", 
               states = c("Susceptible", "Infectado"),
               transitionMatrix = matriz)
cadena1
```
Ahora simulemos la cadena para alguien que empieza `Susceptible` durante 100 días:
```{r}
#Nos devuelve el estado del individuo
sim1 <- rmarkovchain(100, cadena1, "Susceptible")
sim1
```
Y para alguien que empieza `Infectado` durante 73 días:
```{r}

sim2 <- rmarkovchain(73, cadena1, "Infectado")
sim2
```
Ahora creemos una cadena de Markov para un modelo DISMOD, donde suponemos que las probabilidades son las siguientes:

1. P(Seguir sano) = 0.73
2. P(De sano a enfermo) = 0.26 
3. P(De sano a muerto) = 0.01 
4. P(Enfermo a sano) = 0.00 
5. P(Seguir enfermo) = 0.92 
6. P(Enfermo a muerto) = 0.08 
7. P(Muerto a sano) = 0.00
8. P(Muerto a enfermo) = 0.00 
9. P(Seguir muerto) = 1.00

Numericamente, la matríz se vería así:
$$
\begin{array}{ccccc} 
         & Sanos  & Enfermos & Muertos    \\
Sanos    &  0.73  & 0.26     & 0.01       \\
Enfermos &  0.00  & 0.62     & 0.98        \\
Muertos  &  0.00  & 0.00     & 1.00
\end{array}
$$
La matríz en R es:
```{r}
 probs2 <- matrix(c(0.73, 0.26, 0.01, 0.00, 0.92, 0.08, 0.00, 0.00, 1.00),
                          byrow = TRUE, nrow = 3)
```
Creamos la cadena:
```{r}
 cadena2 <- new("markovchain",
               states = c("Sano", "Enfermo","Muerto"),
               transitionMatrix = probs2)
```
Simulamos la cadena para alguien que empieza `Sano` durante 100 días
```{r}
sim1 <- rmarkovchain(100, cadena2, "Sano")
sim1
```
Para alguien que empieza `Enfermo` 121 días
```{r}
sim2 <- rmarkovchain(121, cadena2, "Enfermo")
sim2

```
Y para alguien que empieza `Muerto` 100 días
```{r}
sim3 <- rmarkovchain(107, cadena2, "Muerto")
sim3
```
¿Notas cómo todos acaban eventualmente muertos? A este tipo de estados se les conoce como `absorbentes`: a la larga te absorben y acabas en ellos. La instrucción `summary` indica, entre otras cosas, cuáles estados absorbentes tienes:
```{r}
summary(cadena2)
```
Por otro lado, la instrucción plot muestra la cadena:
```{r}
plot(cadena2)
```

##Ejercicio
1. Programa el modelo SIR y simúlalo. Considera la matríz de probabilidades:
$$
\begin{array}{ccccc} 
         & Sanos  & Enfermos & Muertos    \\
Sanos    &  0.98  & 0.02     & 0.00       \\
Enfermos &  0.00  & 0.88     & 0.12        \\
Muertos  &  0.00  & 0.00     & 1.00
\end{array}
$$
Una vez simulado, agrega ahora una vacuna a dicho modelo. ¿Cómo cambian las simulaciones?¿Cómo se ve el modelo? Nota: Recuerda que tus probabilidades deben de sumar 1 no más ni menos

2. Utiliza un `for` para contar cuántas veces un individuo estuvo en la categoría de `Infectado` durante una simulación de la cadena de Markov cadena1 a lo largo de 100 días. Usa la semilla 321.



