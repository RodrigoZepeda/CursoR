---
title: "Cambios en las interrupciones legales del embarazo en Ciudad de México a partir de la pandemia de SARS-CoV-2"
author: "Rodrigo Zepeda"
date: "rodrigo.zepeda@imss.gob.mx"
output:
  html_document:
    df_print: paged
  pdf_document: 
    latex_engine: lualatex
urlcolor: blue
bibliography: refs.bib
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Introducción

La pandemia por SARS-CoV-2 ha resultado en interrupciones a la prestación de algunos servicios de salud en México @doubova2021disruption. Al inicio de la misma varios actores internacionales alzaron la voz para evitar que la respuesta a la pandemia interfiriera con la prestación de este servicio de salud  @turret2020covid @todd2020abortion. El **objetivo** de este análisis es estudiar si hubo un **cambio en el número de ILE realizados después del inicio de la pandemia por SARS-CoV-2**.

### Ambiente de `R` 
Para el análisis siguiente utilicé las librerías que aparecen a continuación:
```{r, message = FALSE}
#Paquetes requeridos
library(tidyverse)   #Librería de análisis de datos
library(kableExtra)  #Para hacer tablas bonitas
library(knitr)       #Para formato en pdf
library(wesanderson) #Colores como las películas de este señor
library(ggformula)   #Splines
library(lubridate)   #Fechas
```

### Descripción de la base

Los datos utilizados para este análisis provienen de la base sobre la **Interrupción Legal del Embarazo** (ILE) disponible en el portal de datos del gobierno de la Ciudad de México [https://datos.cdmx.gob.mx/explore/dataset/interrupcion-legal-del-embarazo/table/](https://datos.cdmx.gob.mx/explore/dataset/interrupcion-legal-del-embarazo/table/). Dicha base contiene los registros de ILE que ocurrieron en clínicas y hospitales de la Secretaría de Salud de la Ciudad de México del primero de enero del año 2016 al 20 de mayo del 2021.  


```{r}
# Lectura de la base desde Internet
direccion.web    <- "~/CursoR/ile_completo.csv"
ile.data         <- read_csv(direccion.web, show_col_types = FALSE)

# Lectura del diccionario de datos desde su dirección web
direccion.web    <- "~/CursoR/diccionario-de-datos-ile.csv"
diccionario.data <- read_csv(direccion.web, show_col_types = FALSE)
```

Las variables contenidas en la base son:
```{r, echo = F}
variables <- diccionario.data %>% select(Variable, Descripción)
variables %>% kable() %>% kable_styling(latex_options = c("striped","hold_position"))
```

## Análisis exploratorio con código 

La distribución de edad por año está dada por la siguiente tabla:

```{r, echo = F}
ile.data %>%
  filter(!is.na(año)) %>%
  group_by(año) %>%
  summarise(
    `Media`   = mean(edad),
    `SD`      = sd(edad),
    `Mediana` = median(edad),
    `Mínimo`  = min(edad),
    `Máximo`  = max(edad)
  ) %>%
  kable() %>%
  kable_styling(latex_options = c("striped","hold_position"))
```

donde la edad mínima registrada fue de `r min(ile.data$edad, na.rm = T)` mientras que la máxima fue de: `r max(ile.data$edad, na.rm = T)`. 

Se realizó un histograma con $25$ rectángulos y un ajuste por densidad kernel con núcleo gaussiano para determinar la forma de la distribución de los datos por año. Ésta es como sigue:

```{r, warning=FALSE, echo = F}
#Gráfica para la distribución de edad:
ile.data %>% 
  filter(!is.na(año)) %>% 
  ggplot() +
  geom_histogram(aes(x = edad, y = ..density.., fill = as.character(año)), 
                 bins = 25, color = "white") +
  geom_density(aes(x = edad), color = "black", size = 1) +
  theme_minimal() + 
  facet_wrap(~año, ncol = 2, scales = "fixed") +
  xlab("Edad") +
  ylab("Densidad ajustada") +
  ggtitle(paste0("Distribución de la edad en acceso a ILE en clínicas", 
  "y hospitales\nde la CDMX, 2016 a mayo 2021.")) +
  labs(
    subtitle = "Datos del Portal de Datos Abiertos de la CDMX",
    caption = "Gráfica elaborada por Rodrigo Zepeda."
  ) +
  scale_fill_manual("Año", values = wes_palette("Darjeeling1", n = 7, "continuous")) 
```

La cantidad de interrupciones elaboradas pre y post pandemia parece haber disminuido más de lo usual:

```{r}
ile.data %>% 
  filter(!is.na(año)) %>% 
  group_by(año) %>%
  tally() %>%
  rename(`Total de ILE registradas` = n) %>%
  rename(`Año` = año) %>%
  kable() %>%
  kable_styling(latex_options = c("striped","hold_position"))
```
Si graficamos los totales por día podemos obtener una mejor idea del comportamiento de la serie. Hemos agregado un suavizamiento mediante _splines_  para distinguir la tendencia

```{r}
ile.data <- ile.data %>% 
  filter(!is.na(año) & !is.na(fingreso) & año >= 2016) %>% 
  mutate(fingreso = ymd(fingreso)) 

ile.data %>%
  group_by(`fingreso`) %>%
  tally() %>%
  ggplot() +
  geom_line(aes(x = `fingreso`, y = n, color = "Observaciones"), alpha = 0.5) +
  geom_spline(aes(x = `fingreso`, y = n, color = "Tendencia"), nknots = 5, 
              size = 2) +
  theme_minimal() +
  labs(
    x = "Fecha de ingreso",
    y = "Total de interrupciones",
    title = "Total de Interrupciones Legales del Embarazo en Ciudad de México",
    subtitle = "Datos del Portal de Datos Abiertos de la CDMX",
    caption = "Elaborada por Rodrigo Zepeda"
  ) +
  scale_color_manual("Datos", values = rev(wes_palette("Darjeeling1"))) +
  geom_vline(aes(xintercept = dmy("27-02-2020")), linetype = "dashed") +
  annotate("label", x = dmy("27-02-2020"), y = 100, 
           label = "Inicio de la pandemia", angle = 90)
```
La siguiente tabla muestra la composición sociodemográfica de las personas que llegaban antes y después de la pandemia por entidad (la cual inició el 27 de febrero 2020 de acuerdo con @suarez2020epidemiologia). Podemos notar que no existen diferencias relevantes en cuanto a quienes asistieron a la prestación del servicio (es decir, legalizar en Oaxaca e Hidalgo no parece haber influido en el porcentaje registrado por entidad en CDMX). 

```{r}
#Variable de pandemia
ile.data <- ile.data %>%
  mutate(`Pandemia` = if_else(fingreso < dmy("27-02-2020"), 
                              "Pre pandemia", "Pandemia")) 

#Variable de estado
origen <-   ile.data %>%
  filter(!is.na(entidad)) %>%
  group_by(Pandemia, entidad) %>%
  summarise(n = n(), .groups = "keep") 

ile.data %>%
  filter(!is.na(entidad)) %>%
  group_by(Pandemia) %>%
  summarise(Total_pandemia = n(), .groups = "keep") %>%
  right_join(origen, by = "Pandemia") %>%
  mutate(`Entidad (%)` = n/Total_pandemia) %>%
  select(Pandemia, entidad, `Entidad (%)`) %>%
  pivot_wider(id_cols = entidad, names_from = Pandemia, 
              values_from = `Entidad (%)`) %>%
  select(entidad, `Pre pandemia`, Pandemia) %>%
  rename(Entidad = entidad) %>%
  filter(!is.na(Pandemia) & !is.na(`Pre pandemia`)) %>%
  arrange(-Pandemia) %>%
  kable() %>%
  kable_styling(latex_options = c("striped","hold_position"))

```

Si bien de la asociación entre pandemia y reducción de casos no podemos concluir causalidad (es decir no podemos concluir que la pandemia redujo los casos) sí podemos concluir que hay una asociación entre el inicio de la pandemia y los casos y que dicha asociación no parece ser explicada por las variables sociales. Hacen falta más análisis con ecuaciones estructurales para deducir la causalidad. 

# Referencias
